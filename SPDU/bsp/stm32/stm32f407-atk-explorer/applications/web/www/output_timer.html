<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>outputtimer</title>

<script type="text/javascript" src="ajax.js"></script>
<script type="text/javascript">



//添加选项option
function addOption(num)
{
    for(var i=0;i<=num;i++){
		var obj = document.getElementById('sel_'+i);   
        obj.options.add(new Option("禁用模式",0));
		obj.options.add(new Option("每天定时",1)); 
		obj.options.add(new Option("循环定时",2)); 
		obj.options.add(new Option("单次定时",3)); 
		obj.options.add(new Option("ATS 定时",4));
		obj.setAttribute("onchange", "selOnchange({0},this.value)".format(i));		
    }
}

// 设置输入框的类型
function setInputType(obj, v)
{
	var type = 'text', str='';
	if(Number(v) > 0) {
		switch(Number(v)) {
		case 1: type = 'time'; str = new Date().Format("HH:mm:ss"); break;
		case 3: type = 'datetime-local'; str = new Date().Format("yyyy-MM-ddTHH:mm:ss"); break;
		case 2:  
		case 4: type = 'number'; str = 5; break;
		}		
		obj.disabled = false;
	} else {
		obj.disabled = 'disabled';
	}
	obj.setAttribute("type", type);	
	obj.style.width = "180px";	
	obj.value = str;
}


// 定时模式改变时，设定输入框的类型
function selOnchange(id, v)
{
	var obj = document.getElementById('open_'+id);	
	setInputType(obj, v);
	obj = document.getElementById('close_'+id);	
	setInputType(obj, v);
}

// 以对像来设置一行定时数据  var obj = {id:1, en_1:2, open_1:3, close_1:4};
function setTimerByObj(id, obj)
{
	var en = obj["en_"+id];
	selOnchange(id, en);
	
	var e = document.getElementById('open_'+id);
	e.value = obj["open_"+id];
	
	e = document.getElementById('close_'+id);
	e.value = obj["close_"+id];	
	
	document.getElementById('sel_'+id).value = en;	

	return en;
}


function updateTimers(obj)
{
	var ret, num = Number(obj.num);	
	for(var i=1; i<=num; ++i) {
		ret = setTimerByObj(i, obj);
		
		if(4 == ret) { // ATS定时计划时，下一位被禁用
			if(++i <= num)
				selOnchange(i, 0);
		}
	}	
}


function getTimers()
{
	var options = { url: 'getTimers', 
	  data: 'num=0', 	
	  success: function(obj) {
			updateTimers(obj);			
	  },
	  fail: function(err) {	
	  }
	};	
	ajaxRequest(options);
}

// 增加一行表格
function addtr(id)
{
	 var tab=document.getElementById('tab');
	 var tradd=tab.insertRow(id);
		 
	if (id%2) tradd.style.background = "#F5F5F5";
	tradd.align="center";
	
	var fma = {id:id};	
	var html = '<td height="22px">{id}</td>' + 
                '<td> <select id="sel_{id}"> </select> </td>' + 
                '<td> <input id="open_{id}"/> </td>' +
                '<td> <input id="close_{id}"/> </td>' +
				'<td> <input type="button" value="提交" onClick="setSlave({id});"/> </td>'; 
	 tradd.innerHTML=html.format(fma);  		
}

// 创建表格
function createTab(num)
{
	for(var i=1; i<=Number(num); ++i) {
		addtr(i, 1);
	}
	addOption(num);	
}

// 获取输出位数量
function getOutputNum() 
{
	var options = { url: 'getOutputNum', 
	  data: 'num=0', 	
	  success: function(obj) {
			createTab(obj.num);			
	  },
	  fail: function(err) {	
	  }
	};	
	ajaxRequest(options);
}



// 网页加载时执行函数	
function pageload() 
{	
	getOutputNum();
	getTimers();
	selOnchange(0, 0);
	
	// 测试代码
	// createTab(10);
	// var arr = {id:5, en_5:3, open_5:"2014-01-16T15:25:33", close_5:"2014-11-16T15:25:33"};
	// setTimerByObj(5, arr); 
}

function checkInput(id)
{	
	var open = document.getElementById('open_'+id).value;
	if (open==null || open=="") {
		alert("开启时间输入有误，请重新输入!");	return false;
	}
	
	var close = document.getElementById('close_'+id).value;
	if (open==null || open=="") {
		alert("断开时间输入有误，请重新输入!");	return false;
	}

	var ret = confirm("\n操作确认执行此?\n"); 
	return ret;
}

function setSlave(id)
{
	var ret = checkInput(id);
	if(ret) {
		var en = document.getElementById('sel_'+id).value;
		var open = document.getElementById('open_'+id).value;
		var close = document.getElementById('close_'+id).value;
		
		var options = { url: 'setTimer', 
		  data: 'id={0}&en={1}&open={2}&close={3}'.format(id, en, open, close), 	
		  success: function(res) {
			if(0 == res.id) {
				location.reload();
			}
		  },
		  fail: function(err) {
				alert("操作失败");		
		  }
		};	
		ajaxRequest(options);
	}	
}
	
</script>
</head>

<body onLoad="pageload();" style="margin:0px; overflow-x :hidden;">
<div id="lg" style="width:700px; height:auto; border-style:solid; border-width:1px;border-color:#aaaaff;">
        <table id="tab" width="700" style="font-size:12px;">
            <tr align="center" style="color:#FFFFFF;background:#0054A8;">
                <td height="22px">编号</td>
                <td>定时模式</td>
                <td>开启时间</td>
				<td>断开时间</td>
                <td>操作</td>
            </tr>
            <tr align="center"  style="background:#EEEE00;">
                <td height="22px">全部</td>
                <td> <select id="sel_0" > </select> </td>
                <td> <input id="open_0" /> </td>
                <td> <input id="close_0" /> </td>
				<td> <input type="button" value="提交" onClick="setSlave(0);"/> </td>
            </tr>            
        </table>
		
		端口定时说明：<br />
		端口定时即可以为每个输出端口制定一个定时计划，<br />
		定时计划提供：每天定时，循环定时、单次定时、ATS定时，四种定时模式，其中：<br />
		1、每天定时：即每天在确定的时间，开启或者关闭输出端口的定时计划：<br />
			启用每天定时功能时，在输入框中请输入"时:分:抄“ 如:08:07:06<br />
		2、循环定时：即循环开启和关闭输出端口的定时计划：此功能输入框中请输入需要的时间间隔，以秒为单位 <br />
		3、单次定时：即指定在某天某时，开启和闭关输出端口：请填写：2019-07-01 08:07:06 <br />
		4、ATS定时：即不间断供电定时计划：如设置第一个端口为ATS定时功能，接下来第二个口，请设置为禁用模式，<br />
			当第一个口为开启时，第二个口为断开，持续一段时间，第二个口为开启，第一个口为断开，如此循环
		
</div>
</body>
</html>