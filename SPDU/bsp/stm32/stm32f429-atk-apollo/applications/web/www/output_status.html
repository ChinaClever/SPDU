<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>outputstatus</title>

<script type="text/javascript" src="ajax.js"></script>
<script type="text/javascript">

// 获取开关字符串
function getSwStr(sw) 
{
	var ret = '接通';
	if(sw == 0) ret = '断开';
	return ret;
}

// 设置开关状态时的背景色
function setSwStr(sw) 
{
	var color = "#000000";
	if(sw == 0) color = "#FF0000";
	return color;
}

// 设置所有网页开关状态
function setWebAllSw(sw)
{
	var tab = document.getElementById("tab") ;
    var i, rows = tab.rows.length;
	for(i=1; i<rows; ++i) {
		setWebSw(i, sw);
	}
}

// 设置网页开关状态
function setWebSw(id, sw) 
{
	if(id > 0) { 	
		var key = "output_sw_{0}".format(id);
		var obj = document.getElementById(key);
		obj.innerHTML = getSwStr(sw);
		obj.style.color = setSwStr(sw);	
	} else {
		setWebAllSw(sw);
	}
}

//添加选项option
function addOptions(num)
{
    for(var i=0;i<=Number(num);i++){
		var obj = document.getElementById('sel_'+i);   
        obj.options.add(new Option("默认断开",0));
		obj.options.add(new Option("默认接通",1)); 
		obj.options.add(new Option("状态恢复",2));
		obj.setAttribute("onchange", "setInitial({0},this.value)".format(i));		
    }
}

// 增加一行表格
function addtr(id, sw)
{
	 var tab=document.getElementById('tab');
	 var tradd=tab.insertRow(id);
		 
	if (id%2) tradd.style.background = "#F5F5F5";
	tradd.align="center";
	
	var fma = {id:id, sw: getSwStr(sw)};	
	var html = '<td height="22px">{id}</td>' +
			"<td> Output{id} </td>" +
			'<td id="output_sw_{id}"> {sw} </td>' +
			'<td> <select id="sel_{id}"> </select> </td>' +
			'<td> <input type="button" value="开启" onClick="setsw({id},1);"/>' +
			'<input type="button" value="关闭" onClick="setsw({id},0);"/></td>' + 
			'<td> <input type="button" value="复位" onClick="setSwReset({id});"/></td>';	
	 tradd.innerHTML=html.format(fma);  		
}

// 更新默认设置
function updateInitial(obj)
{
	for(var i=1; i<=obj.num; ++i) {		 
		var v = Number(obj['sel_'+i])
		document.getElementById('sel_'+i).value = v;
	}
}

// 获取默认设置数据
function getInitialStatus() 
{
	var options = { url: 'getInitial', 
	  data: 'num=0', 	
	  success: function(obj) {
			updateInitial(obj);			
	  },
	  fail: function(err) {	
	  }
	};	
	ajaxRequest(options);
}

// 更新开关状态
function updateStatus(obj)
{
	var i,sw, num = Number(obj.num);
	for(i=1; i<=num; ++i) {
		sw = Number(obj['sw_'+i])
		setWebSw(i, sw);
	}	
}

// 获取开关状态数据
function getOutputStatus() 
{
	var options = { url: 'getOutputStatus', 
	  data: 'num=0', 	
	  success: function(obj) {
			updateStatus(obj);			
	  },
	  fail: function(err) {	
	  }
	};	
	ajaxRequest(options);
}

// 创建表格
function createTab(num)
{
	for(var i=1; i<=Number(num); ++i) {
		addtr(i, 1);
	}
	addOptions(num);	
}

// 获取输出位数量
function getOutputNum() 
{
	var options = { url: 'getOutputNum', 
	  data: 'num=0', 	
	  success: function(obj) {
			createTab(obj.num);			
	  },
	  fail: function(err) {	
	  }
	};	
	ajaxRequest(options);
}

// 网页加载时执行函数	
function pageload() 
{
	getOutputNum(); 
	getOutputStatus();
	getInitialStatus();
	
	window.setInterval("getOutputStatus()",4250);
	
	/*
	var i, num = 8;
	for(i=1; i<=num; ++i) {
		 addtr(i, 1);
	}	
	addOptions(num);
	*/
}

// 开关设置时触发函数
function setsw(id, sw) 
{	
	if(!confirm("\n操作确认执行此?\n")) return;
	
	var options = { url: 'setSw', 
	  data: 'id={0}&sw={1}'.format(id, sw), 	
	  success: function(res) {	
			updateStatus(res);
			// alert("操作成功");
	  },
	  fail: function(err) {
			alert("操作失败");		
	  }
	};	
	ajaxRequest(options);
}


// 默认设置时触发函数
function setInitial(id, v)
{	
	var options = { url: 'setInitial', 
	  data: 'id={0}&sel={1}'.format(id, v), 	
	  success: function(res) {
			if(0 == res.id) {
				location.reload();
				document.getElementById('sel_0').value = res.sel;
			}
			alert("修改成功");			
	  },
	  fail: function(err) {
			alert("修改失败");		
	  }
	};	
	ajaxRequest(options);
}

// 顺序上下电
function setSeqSw(sw)
{
	var ret = prompt(" 请输入时间间隔： 单位（秒）小于255的值","3")
	if (ret!=null && ret!="") {
		var options = { url: 'setSeqSw', 
		  data: 'sw={0}&sec={1}'.format(sw, ret), 	
		  success: function(response) {		
		  },
		  fail: function(err) {
				alert("操作失败");		
		  }
		};	
		ajaxRequest(options);
	}
}

// 复位设置
function setSwReset(id)
{
	var ret = prompt(" 请输入开关复位时间： 单位（秒）小于255的值","3")
	if (ret!=null && ret!="") {
		var options = { url: 'setSwReset', 
		  data: 'id={0}&sec={1}'.format(id, ret), 	
		  success: function(response) {
		  },
		  fail: function(err) {
				alert("操作失败");		
		  }
		};	
		ajaxRequest(options);
	}
}
	
</script>
</head>

<body onLoad="pageload();" style="margin:0px; overflow-x :hidden;">
<div id="lg" style="width:700px; height:auto; border-style:solid; border-width:1px;border-color:#aaaaff;">
        <table id="tab" width="700" style="font-size:12px;">
            <tr align="center" style="color:#FFFFFF;background:#0054A8;">
                <td height="22px">编号</td>
                <td>输出单元</td>
                <td>开关状态</td>
				<td>默认设置</td>
                <td>操作</td>
				<td>复位</td>
            </tr>
            <tr align="center"  style="background:#EEEE00;">
                <td height="22px">---</td>
                <td>全部</td>
                <td id="output_sw_0"> 顺序：
					<input type="button" value="上电" onClick="setSeqSw(1);"/> 
					<input type="button" value="下电" onClick="setSeqSw(0);"/>
				</td>
				<td> <select id="sel_0" ></select> </td>
                <td>
					<input type="button" value="全开" onClick="setsw(0,1);"/> 
					<input type="button" value="全关" onClick="setsw(0,0);"/>
				</td>
				<td> <input type="button" value="全复位" onClick="setSwReset(0);"/>  </td>
            </tr>            
        </table>
		此页面用来展示各输出断开的通断状态，和手动开启或闭关任意输出端口<br />
		复位：即让输出端口，断开一段时间，然后再重新开启
		顺序上\下电：即有顺序的让端口依次的能电和断开
</div>
</body>
</html>
